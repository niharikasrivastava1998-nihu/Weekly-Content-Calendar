<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    // AUTOMATION: Pre-setting your key
    const DEFAUT_KEY = "AIzaSyA6Qa_e_VopFP5J0MAatNLCo-lmDn4SWvc";
    
    // Initialize storage if empty
    if (!localStorage.getItem('GEMINI_KEY')) {
        localStorage.setItem('GEMINI_KEY', DEFAUT_KEY);
    }

    window.showSection = (sectionId, btnElement) => {
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
        btnElement.classList.add('nav-active');
    };

    window.saveApiKey = () => {
        const key = document.getElementById('apiKeyInput').value;
        localStorage.setItem('GEMINI_KEY', key);
        alert("API Key updated!");
    };

    // UI Initialization
    document.getElementById('apiKeyInput').value = localStorage.getItem('GEMINI_KEY');

    document.getElementById('generateBtn').addEventListener('click', async () => {
        const apiKey = localStorage.getItem('GEMINI_KEY');
        const niche = document.getElementById('nicheInput').value;

        if (!apiKey) return alert("API Key missing.");
        if (!niche) return alert("Please enter a niche.");

        const btn = document.getElementById('generateBtn');
        btn.disabled = true;
        btn.innerHTML = `<span>⏳ Generating 30-Day Plan...</span>`;

        try {
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

            const prompt = `Create a 30-day Instagram content plan for: ${niche}. 
            Return ONLY a raw JSON array of 30 objects. 
            Each object: {"day": 1, "type": "Reel/Carousel/Story", "topic": "Title", "hook": "First line"}.`;

            const result = await model.generateContent(prompt);
            const response = await result.response;
            const text = response.text().replace(/```json/g, "").replace(/```/g, "").trim();
            const plan = JSON.parse(text);

            renderCalendar(plan);
            // Auto-switch to calendar view
            showSection('calendar', document.querySelectorAll('.nav-btn')[1]);

        } catch (error) {
            console.error(error);
            alert("Analysis failed. Ensure the API key is active.");
        } finally {
            btn.disabled = false;
            btn.innerHTML = `<span>✨ Generate 30-Day Plan</span>`;
        }
    });

    function renderCalendar(data) {
        const container = document.getElementById('calendarContent');
        container.innerHTML = "";
        data.forEach(item => {
            const dayDiv = document.createElement('div');
            dayDiv.className = "day-box glass-card rounded-xl p-3 flex flex-col justify-between shadow-sm border-t-4 " + 
                               (item.type === 'Reel' ? 'border-blue-500' : (item.type === 'Carousel' ? 'border-purple-500' : 'border-slate-300'));
            dayDiv.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xl font-black text-slate-200">${item.day}</span>
                    <span class="text-[10px] font-bold px-1.5 py-0.5 rounded bg-slate-100 text-slate-600 uppercase">${item.type}</span>
                </div>
                <div class="text-xs font-bold leading-tight mb-1 line-clamp-2">${item.topic}</div>
                <div class="text-[10px] text-slate-500 italic line-clamp-2">"${item.hook}"</div>`;
            container.appendChild(dayDiv);
        });
    }
</script>
